{% extends "parent.html" %}

{% block body %} 

<div class="container py-5">
  <div class="row">
    <div class="col-md-6">
      <div class="text-center">
          <h2 class="mb-4">Upload an Image</h2>
          <form id="uploadForm" class="p-3 border rounded bg-white shadow">
                <div class="mb-3">
                    <label for="img" class="form-label">Upload Image:</label>
                    <input type="file" id="img" class="form-control" accept="image/*" required>
                </div>
                <div id="status" class="mt-3"></div>
                <button type="submit" class="btn btn-primary">Upload</button>
            </form>
      </div>
          <div class="mb-3 text-center">
              <img id="file-preview" class="img-fluid rounded" style="display: none; max-width: 100%; max-height: 512px;" alt="Image Preview">
          </div>
          <!-- Display the predicted image if available -->
          <div class="mb-3 text-center" id="predicted-image-container" style="display: none;">
              <img id="segmented-image" class="img-fluid border rounded mb-3" style="width: 100%; max-height: 300px; object-fit: contain;">
          </div>
    </div>

    <div class="col-md-6">
      <div class="canvas-container">
        <canvas id="canvas" class="border" height="512" width="512"></canvas>
      </div>
      <!-- Zoom Buttons -->
      <div class="mt-3">
        <button id="zoom-in" class="btn btn-secondary">Zoom In</button>
        <button id="zoom-out" class="btn btn-secondary">Zoom Out</button>
      </div>
      <div class="mb-3">
          <label for="drawing-color" class="form-label">Drawing Color:</label>
          <input type="color" id="drawing-color" class="form-control w-75" value="#000000">
      </div>
      <div class="mb-3">
          <label for="drawing-line-width" class="form-label">Line Width:</label>
          <input type="number" id="drawing-line-width" class="form-control w-75" value="5">
      </div>
      <button id="toggle-draw-mode" class="btn btn-primary">Enter Draw Mode</button>
      <button id="clear-canvas" class="btn btn-danger">Clear Canvas</button>
    </div>
  </div>
</div>

<script>
    // Show image preview before upload
    document.getElementById('img').addEventListener('change', function(event) {
        const preview = document.getElementById('file-preview');
        const file = event.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                preview.src = e.target.result;
                preview.style.display = 'block'; // Show the preview image
            };
            reader.readAsDataURL(file);
        }
    });

    // Handle image upload and prediction request
    document.getElementById('uploadForm').addEventListener('submit', async function (event) {
        event.preventDefault(); // Stop form from refreshing the page

        const fileInput = document.getElementById('img');
        const statusElement = document.getElementById('status');
        const predictedImageContainer = document.getElementById('predicted-image-container');
        const segmentedImage = document.getElementById('segmented-image');
        
        statusElement.textContent = 'Uploading...';

        if (fileInput.files.length === 0) {
            statusElement.textContent = 'Please select an image.';
            return;
        }

        const file = fileInput.files[0];
        const reader = new FileReader();

        reader.onload = async function () {
            const base64Image = reader.result.split(',')[1]; // Extract the base64 data
            const payload = { image: base64Image };

            try {
                // Send the base64 image to the /prediction endpoint for prediction
                const response = await fetch('/prediction', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });

                if (response.ok) {
                    const data = await response.json();
                    const predictedImageBase64 = data.image; // Assuming the server returns the base64 image

                    // Display the predicted image
                    segmentedImage.src = 'data:image/png;base64,' + predictedImageBase64;
                    predictedImageContainer.style.display = 'block'; // Show the predicted image container
                    statusElement.textContent = 'Upload successful!';
                } else {
                    statusElement.textContent = 'Upload failed!';
                }
            } catch (error) {
                statusElement.textContent = 'Error: ' + error.message;
            }
        };

        reader.readAsDataURL(file); // Read the file as a data URL
    });
</script>

{% endblock %}
